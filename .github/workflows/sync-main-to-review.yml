# .github/workflows/sync-main-to-review.yml

# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Sync main, Create PR to main

# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  push:
    branches:
      - main

# ì‹¤í–‰í•  ì‘ì—…ë“¤ì˜ ëª©ë¡
jobs:
  sync-and-pr: # job ì´ë¦„ ë³€ê²½ (ê°€ë…ì„±)
    runs-on: ubuntu-latest
    
    # [ê°€ì¥ ì¤‘ìš”í•œ ë³€ê²½ì ] ì´ ì‘ì—…ì— í•„ìš”í•œ ê¶Œí•œì„ ëª…ì‹œì ìœ¼ë¡œ ë¶€ì—¬í•©ë‹ˆë‹¤.
    permissions:
      contents: write      # ë ˆí¬ì§€í† ë¦¬ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒí•˜ê³ , ì»¤ë°‹í•˜ê³ , í‘¸ì‹œí•  ê¶Œí•œ
      pull-requests: write # Pull Requestë¥¼ ìƒì„±í•  ê¶Œí•œ

    steps:
      # 1. GitHub Actionsê°€ ì½”ë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ìë™ ì»¤ë°‹ì„ ìœ„í•œ Git ìœ ì € ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 3. main ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ review ë¸Œëœì¹˜ë¡œ ë³‘í•©í•˜ê³  í‘¸ì‹œí•©ë‹ˆë‹¤.
      - name: Merge main into review and push
        run: |
          git checkout review
          git merge origin/main -m "chore: Auto-sync from main"
          git push origin review

      # 4. 'review' -> 'main'ìœ¼ë¡œ Pull Requestë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Create Pull Request if not exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 'review' ë¸Œëœì¹˜ì—ì„œ 'main' ë¸Œëœì¹˜ë¡œ ê°€ëŠ” PRì´ ì´ë¯¸ ì—´ë ¤ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
          existing_pr=$(gh pr list --head review --base main --state open --json number)
          
          # ì´ë¯¸ ì—´ë¦° PRì´ ì—†ë‹¤ë©´ (ê²°ê³¼ê°€ '[]' ë¼ë©´) ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.
          if [ "$existing_pr" == "[]" ]; then
            echo "Creating a new pull request."
            gh pr create \
              --base main \
              --head review \
              --title "ğŸ¤– [Auto PR] Review changes from main" \
              --body "This PR was automatically created by a GitHub Action. Please review the changes and merge when ready. /cc @Seung-zedd"
          else
            echo "An open pull request from 'review' to 'main' already exists."
          fi
