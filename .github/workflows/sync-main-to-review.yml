# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Sync main to review branch

# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í• ì§€ ì •ì˜
on:
  # main ë¸Œëœì¹˜ì— í‘¸ì‹œ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ
  push:
    branches:
      - main

# ì‹¤í–‰í•  ì‘ì—…ë“¤ì˜ ëª©ë¡
jobs:
  sync:
    # ì´ ì‘ì—…ì€ ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    steps:
      # 1. GitHub Actionsê°€ ì½”ë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë ˆí¬ì§€í† ë¦¬ë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ëª¨ë“  ë¸Œëœì¹˜ì™€ ì»¤ë°‹ ê¸°ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
          fetch-depth: 0

      # 2. ìë™ ì»¤ë°‹ì„ ìœ„í•œ Git ìœ ì € ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 3. main ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ review ë¸Œëœì¹˜ë¡œ ë³‘í•©í•˜ê³  í‘¸ì‹œí•©ë‹ˆë‹¤.
      - name: Merge main into review and push
        run: |
          # 'review' ë¸Œëœì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.
          git checkout review

          # 'main' ë¸Œëœì¹˜ì˜ ìµœì‹  ë‚´ìš©ì„ 'review' ë¸Œëœì¹˜ë¡œ ë³‘í•©í•©ë‹ˆë‹¤.
          # "chore: Auto-sync from main" ë¼ëŠ” ë©”ì‹œì§€ë¡œ ìë™ ì»¤ë°‹ë©ë‹ˆë‹¤.
          git merge origin/main -m "chore: Auto-sync from main"

          # ë³€ê²½ëœ 'review' ë¸Œëœì¹˜ë¥¼ ë‹¤ì‹œ GitHubë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤.
          git push origin review

      # 4. 'review' -> 'main'ìœ¼ë¡œ Pull Requestë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ê°€ì¥ í° ë³€ê²½ì )
      - name: Create Pull Request if not exists
        env:
          # PR ìƒì„± ê¶Œí•œì„ ìœ„í•´ GitHub í† í°ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 'review' ë¸Œëœì¹˜ì—ì„œ 'main' ë¸Œëœì¹˜ë¡œ ê°€ëŠ” PRì´ ì´ë¯¸ ì—´ë ¤ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
          existing_pr=$(gh pr list --head review --base main --state open --json number)
          
          # ì´ë¯¸ ì—´ë¦° PRì´ ì—†ë‹¤ë©´ (ê²°ê³¼ê°€ '[]' ë¼ë©´) ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.
          if [ "$existing_pr" == "[]" ]; then
            echo "Creating a new pull request."
            gh pr create \
              --base main \
              --head review \
              --title "ğŸ¤– [Auto PR] Review changes from main" \
              --body "This PR was automatically created by a GitHub Action. Please review the changes and merge when ready. /cc @Seung-zedd"
          else
            echo "An open pull request from 'review' to 'main' already exists."
          fi
